{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="row mb-4 align-items-center">
  <div class="col">
    <h2><i class="bi bi-wrench"></i> Servicios Realizados</h2>
    <p class="text-muted small">Gestiona todos los servicios de tu taller</p>
  </div>
  <div class="col-auto">
    <a href="{% url 'servicios:create' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-1"></i> Nuevo Servicio
    </a>
  </div>
</div>

{% if servicios %}
  <div class="row g-3">
    {% for s in servicios %}
    <div class="col-lg-6 col-xl-4">
      <div class="card h-100 shadow-sm border-0" style="transition: all 0.3s ease;">
        <!-- Header -->
        <div class="card-header" style="background: linear-gradient(135deg, #2B4C7E 0%, #1e3a5f 100%); border: none; color: white;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0 text-white">#{{ s.id }} - {{ s.vehiculo.patente }}</h5>
              <small class="text-white">{{ s.vehiculo.marca }} {{ s.vehiculo.modelo }}</small>
            </div>
            <span class="badge bg-info">{{ s.get_estado_display }}</span>
          </div>
        </div>

        <!-- Body -->
        <div class="card-body">
          <div class="mb-3">
            <p class="mb-1"><strong><i class="bi bi-person"></i> Cliente:</strong> {{ s.vehiculo.cliente.nombre }}</p>
            <p class="mb-1"><strong><i class="bi bi-calendar"></i> Fecha:</strong> {{ s.fecha_servicio|date:"d/m/Y" }}</p>
            <p class="mb-1"><strong><i class="bi bi-cash"></i> Costo:</strong> <span class="text-success fw-bold">${{ s.total|floatformat:0|intcomma }}</span></p>
          </div>

          {% if s.descripcion_trabajo %}
          <div class="mb-3">
            <p class="text-muted small"><em>{{ s.descripcion_trabajo|truncatewords:15 }}</em></p>
          </div>
          {% endif %}

          <!-- Cambiar estado -->
          <div class="mb-3">
            <form method="post" action="{% url 'servicios:cambiar_estado' s.id %}">
              {% csrf_token %}
              <select name="estado" onchange="this.form.submit()" class="form-select form-select-sm">
                <option value="pendiente" {% if s.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="proceso" {% if s.estado == 'proceso' %}selected{% endif %}>En proceso</option>
                <option value="completado" {% if s.estado == 'completado' %}selected{% endif %}>Completado</option>
                <option value="cancelado" {% if s.estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
              </select>
            </form>
          </div>

          <!-- Botón principal -->
          <div class="d-grid gap-2">
            <a href="{% url 'servicios:documentos_servicio' s.id %}" class="btn btn-primary btn-sm">
              <i class="bi bi-eye me-1"></i> Ver Detalles
            </a>
          </div>
        </div>

        <!-- Footer -->
        <div class="card-footer border-top">
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge bg-info text-dark">{{ s.cotizaciones.count }} cot.</span>
            <div class="btn-group btn-group-sm">
              <a href="{% url 'servicios:update' s.id %}" class="btn btn-outline-warning" title="Editar">
                <i class="bi bi-pencil"></i>
              </a>
              <a href="{% url 'servicios:fotos_servicio' s.id %}" class="btn btn-outline-info" title="Fotos">
                <i class="bi bi-camera"></i>
              </a>
              <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteServiceModal{{ s.id }}" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal eliminar servicio -->
    <div class="modal fade" id="deleteServiceModal{{ s.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Eliminar Servicio</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ¿Seguro que deseas eliminar el servicio <strong>#{{ s.id }}</strong>?<br>
            <small class="text-muted">Se eliminarán cotizaciones y documentos relacionados.</small>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form method="POST" action="{% url 'servicios:delete' s.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Eliminar Servicio</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
{% else %}
<div class="alert alert-warning alert-dismissible fade show">
  <i class="bi bi-exclamation-triangle"></i> <strong>Sin registros.</strong> No hay servicios registrados aún.
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if messages %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
  {% for message in messages %}
  <div class="toast show align-items-center text-white {% if message.tags == 'success' %}bg-success{% elif message.tags == 'error' %}bg-danger{% else %}bg-info{% endif %} border-0">
    <div class="d-flex">
      <div class="toast-body">{{ message }}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endblock %}