{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">{{ accion }} cliente</h4>
    </div>
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">{{ form.nombre.label }} *</label>
            {{ form.nombre }}
            {% if form.nombre.errors %}
              {% for error in form.nombre.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">{{ form.rut.label }}</label>
            {{ form.rut }}
            <div class="form-text">Formato: 12.345.678-9</div>
            {% if form.rut.errors %}
              {% for error in form.rut.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">{{ form.telefono.label }}</label>
            {{ form.telefono }}
            {% if form.telefono.errors %}
              {% for error in form.telefono.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">{{ form.email.label }}</label>
            {{ form.email }}
            {% if form.email.errors %}
              {% for error in form.email.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            {% endif %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">{{ form.contacto.label }}</label>
            {{ form.contacto }}
            {% if form.contacto.errors %}
              {% for error in form.contacto.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">{{ form.direccion.label }}</label>
            {{ form.direccion }}
            {% if form.direccion.errors %}
              {% for error in form.direccion.errors %}
              <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
        <div class="d-flex justify-content-between mt-4">
          {% if popup %}
          <button type="button" class="btn btn-secondary" onclick="(function(){ if(window.opener){ try{window.opener.focus();}catch(e){} } window.close(); })()">
            <i class="bi bi-x-lg me-1"></i> Cerrar
          </button>
          {% else %}
          <a href="{% url 'clientes:list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver
          </a>
          {% endif %}
          <button type="submit" class="btn btn-primary px-4">
            <i class="bi bi-save me-1"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script src="{% static 'js/validacion_rut.js' %}"></script>
<script>
  // Enforce telÃ©fono input formatting: only digits and optional leading +
  (function() {
    const tel = document.querySelector('input[name="telefono"]');
    if (!tel) return;

    function cleanValue(value) {
      // allow leading +, then digits and spaces; remove other chars
      value = String(value || '');
      // keep leading + if present
      const leadingPlus = value.trim().startsWith('+');
      let digits = value.replace(/[^0-9]/g, '');
      if (leadingPlus) digits = '+' + digits;
      return digits;
    }

    tel.addEventListener('input', function(e) {
      const cursor = tel.selectionStart;
      const cleaned = cleanValue(tel.value);
      tel.value = cleaned;
      try { tel.setSelectionRange(cursor, cursor); } catch (err) {}
    });

    // On blur, normalize common formats (remove leading zeros, keep +56 or prepend 56 if starts with 9)
    tel.addEventListener('blur', function() {
      let v = tel.value || '';
      v = v.replace(/\s+/g, '');
      if (v.startsWith('+')) {
        // +56... -> keep as +56...
        // remove any accidental extra pluses
        v = '+' + v.replace(/[^0-9]/g, '');
      } else {
        // digits only
        v = v.replace(/[^0-9]/g, '');
        // if starts with 9 -> assume Chile mobile and prepend 56
        if (v.startsWith('9')) {
          v = '56' + v;
        }
      }
      tel.value = v;
    });
  })();
</script>
{% endblock %}
