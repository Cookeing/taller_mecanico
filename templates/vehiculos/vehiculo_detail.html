{% extends "base.html" %} {% load humanize %} {% block content %}
<div class="container py-4">
  <h2 class="mb-3">
    Vehículo: <span class="text-primary">{{ vehiculo.patente }}</span>
  </h2>

  <p>
    <strong>Cliente:</strong> {{ vehiculo.cliente.nombre|title }} —
    <span class="text-muted">{{ vehiculo.cliente.rut }}</span>
  </p>

  <ul class="list-unstyled mb-4">
    <li><strong>Marca:</strong> {{ vehiculo.marca|default:"-" }}</li>
    <li><strong>Modelo:</strong> {{ vehiculo.modelo|default:"-" }}</li>
    <li><strong>Año:</strong> {{ vehiculo.anio|default:"-" }}</li>
    <li><strong>Chasis:</strong> {{ vehiculo.chasis|default:"-" }}</li>
    <li><strong>Motor:</strong> {{ vehiculo.motor|default:"-" }}</li>
    <li>
      <strong>Kilometraje:</strong>
      {% if vehiculo.kilometraje %} {{ vehiculo.kilometraje|intcomma }}
      <span class="text-muted">km</span>
      {% else %}
      <span class="text-muted">-</span>
      {% endif %}
    </li>
  </ul>

  <hr />

  <h4 class="mt-4">Historial de servicios</h4>

  {% if servicios %}
  <div class="table-responsive">
    <table class="table table-striped table-bordered mt-3 align-middle">
      <thead class="table-dark">
        <tr>
          <th class="text-center">Fecha</th>
          <th class="text-center">Descripción</th>
          <th class="text-center">Estado</th>
          <th class="text-center">Total</th>
          <th class="text-center">Fotos</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for s in servicios %}
        <tr>
          <td class="text-center">{{ s.fecha_servicio|date:"d-m-Y" }}</td>
          <td class="text-center">
          <a href="{% url 'servicios:documentos_servicio' s.id %}" class="btn btn-sm btn-info text-truncate d-inline-block" title="{{ s.descripcion_trabajo }}" style="max-width: 160px;">
          <i class="bi bi-file-earmark-text me-1"></i>
          {{ s.descripcion_trabajo }}
        </a>

        </td>

          <td class="text-center">
            {% if s.estado == "proceso" %}
            <span class="badge bg-warning text-dark">En proceso</span>
            {% elif s.estado == "completado" %}
            <span class="badge bg-success">Completado</span>
            {% elif s.estado == "pendiente" %}
            <span class="badge bg-secondary">Pendiente</span>
            {% elif s.estado == "cancelado" %}
            <span class="badge bg-danger">Cancelado</span>
            {% else %}
            <span class="badge bg-light text-dark"
              >{{ s.estado|capfirst }}</span
            >
            {% endif %}
          </td>
          <td class="text-center fw-bold">
            ${{ s.total|floatformat:0|intcomma }}
          </td>
          <td class="text-center">
            <span class="badge bg-info">{{ s.fotos.count }}</span>
          </td>
          <td class="text-center">
            <a href="{% url 'servicios:fotos_servicio' s.id %}" class="btn btn-sm btn-primary" title="Ver y gestionar fotos">
              <i class="bi bi-camera me-1"></i> Subir Fotos
            </a>
          </td>
        </tr>
        
        <!-- Galería de fotos debajo del servicio -->
        {% if s.fotos.exists %}
        <tr>
          <td colspan="6" class="foto-servicio-bg">
            <div class="p-2">
              <h6 class="mb-2"><i class="bi bi-images"></i> Fotos del Servicio</h6>
              <div class="row g-2">
                {% for foto in s.fotos.all|slice:":6" %}
                  <div class="col-6 col-md-2">
                    <img src="{{ foto.imagen.url }}" 
                         class="img-thumbnail" 
                         alt="Foto del servicio" 
                         style="height: 100px; width: 100%; object-fit: cover; cursor: pointer;"
                         data-bs-toggle="modal" 
                         data-bs-target="#fotoModal{{ foto.id }}">
                  </div>
                  
                  <!-- Modal para ver foto en grande -->
                  <div class="modal fade" id="fotoModal{{ foto.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">{{ foto.descripcion|default:"Foto del Servicio" }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">
                          <img src="{{ foto.imagen.url }}" class="img-fluid" alt="Foto del servicio">
                          <p class="text-muted mt-2">
                            <i class="bi bi-calendar"></i> {{ foto.fecha_captura|date:"d/m/Y H:i" }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
                
                {% if s.fotos.count > 6 %}
                  <div class="col-6 col-md-2">
                    <a href="{% url 'servicios:fotos_servicio' s.id %}" 
                      class="d-flex align-items-center justify-content-center text-decoration-none rounded p-2 bg-light-subtle dark:bg-dark-subtle"
                      style="height: 100px;">
                      <span class="text-center">
                        <i class="bi bi-plus-circle" style="font-size: 2rem;"></i><br>
                        <small>+{{ s.fotos.count|add:"-6" }} más</small>
                      </span>
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted">No hay servicios registrados para este vehículo.</p>
  {% endif %}

  <a href="{% url 'vehiculos:list' %}" class="btn btn-secondary mt-3">Volver</a>
</div>
{% endblock %}
