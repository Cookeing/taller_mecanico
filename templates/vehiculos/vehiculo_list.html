{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Veh√≠culos</h2>
    <a href="{% url 'vehiculos:create' %}" class="btn btn-primary">Nuevo veh√≠culo</a>
  </div>

  <!-- Barra de b√∫squeda de clientes -->
  <div class="mb-3">
    <input id="search-client-input" type="search" class="form-control" placeholder="Buscar veh√≠culos por nombre o RUT del cliente...">
  </div>

  <!-- Barra de b√∫squeda de veh√≠culos -->
  <div class="mb-3">
    <input id="search-vehiculo-input" type="search" class="form-control" placeholder="Buscar veh√≠culos por patente...">
  </div>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Patente</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Cliente</th>
          <th>RUT Cliente</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="results-body">
        {% for v in vehiculos %}
        <tr>
          <td>{{ v.patente }}</td>
          <td>{{ v.marca|default:"-" }}</td>
          <td>{{ v.modelo|default:"-" }}</td>
          <td>{{ v.cliente.nombre }}</td>
          <td>{{ v.cliente.rut }}</td>
          <td>
            <a href="{% url 'vehiculos:detail' v.pk %}" class="btn btn-sm btn-outline-primary">Ver</a>
            <a href="{% url 'vehiculos:edit' v.pk %}" class="btn btn-sm btn-outline-secondary">Editar</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6">No hay veh√≠culos registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
    const clientInput = document.getElementById('search-client-input');
    const vehiculoInput = document.getElementById('search-vehiculo-input');
    const resultsBody = document.getElementById('results-body');

    const apiVehiculosPorCliente = "{% url 'vehiculos:api_buscar_por_cliente' %}";
    const apiVehiculosPorPatente = "{% url 'vehiculos:api_buscar' %}";

    // Datos originales para restaurar cuando no hay b√∫squeda
    let originalData = null;
    let lastClientSearch = '';
    let lastPatenteSearch = '';

    function escapeHtml(str){
        if(!str) return '';
        return String(str).replace(/[&<>'"]/g, function(m){
            return {'&':'&amp;','<':'&lt;','>':'&gt;',"\'":'&#39;','"':'&quot;'}[m];
        });
    }

    function renderVehiculos(items){
        if(!items || items.length === 0){
            resultsBody.innerHTML = '<tr><td colspan="6">No se encontraron veh√≠culos.</td></tr>';
            return;
        }
        let html = '';
        for(const v of items){
            html += `<tr>
                <td>${escapeHtml(v.patente)}</td>
                <td>${escapeHtml(v.marca)}</td>
                <td>${escapeHtml(v.modelo)}</td>
                <td>${escapeHtml(v.cliente || '')}</td>
                <td>${escapeHtml(v.cliente_rut || '')}</td>
                <td>
                    <a href="/vehiculos/${v.id}/" class="btn btn-sm btn-outline-primary">Ver</a>
                    <a href="/vehiculos/${v.id}/editar/" class="btn btn-sm btn-outline-secondary">Editar</a>
                </td>
            </tr>`;
        }
        resultsBody.innerHTML = html;
    }

    function debounce(fn, delay){
        let t; 
        return function(...args){ 
            clearTimeout(t); 
            t = setTimeout(()=>fn.apply(this,args), delay); 
        };
    }

    async function realizarBusquedaCombinada() {
        const clienteQuery = clientInput.value.trim();
        const patenteQuery = vehiculoInput.value.trim();

        // Si ambos campos est√°n vac√≠os, restaurar datos originales
        if (!clienteQuery && !patenteQuery) {
            if (originalData) {
                renderVehiculos(originalData);
            } else {
                window.location.href = "{% url 'vehiculos:list' %}";
            }
            return;
        }

        try {
            let resultados = [];

            // Si hay b√∫squeda por cliente, obtener esos veh√≠culos primero
            if (clienteQuery) {
                console.log(`üîç Buscando cliente: "${clienteQuery}"`);
                const respCliente = await fetch(apiVehiculosPorCliente + '?q=' + encodeURIComponent(clienteQuery));
                if (!respCliente.ok) throw new Error(`Error en b√∫squeda por cliente: ${respCliente.status}`);
                const dataCliente = await respCliente.json();
                resultados = dataCliente;
                console.log(`üìã Veh√≠culos por cliente:`, dataCliente);
            }

            // Si hay b√∫squeda por patente, filtrar los resultados existentes o hacer nueva b√∫squeda
            if (patenteQuery) {
                console.log(`üîç Buscando patente: "${patenteQuery}"`);
                
                if (resultados.length > 0) {
                    // Filtrar los resultados de cliente por patente
                    resultados = resultados.filter(v => 
                        v.patente.toLowerCase().includes(patenteQuery.toLowerCase())
                    );
                    console.log(`üéØ Resultados combinados (filtrados):`, resultados);
                } else {
                    // Si no hay resultados previos, buscar solo por patente
                    const respPatente = await fetch(apiVehiculosPorPatente + '?q=' + encodeURIComponent(patenteQuery));
                    if (!respPatente.ok) throw new Error(`Error en b√∫squeda por patente: ${respPatente.status}`);
                    const dataPatente = await respPatente.json();
                    resultados = dataPatente;
                    console.log(`üöó Veh√≠culos por patente:`, dataPatente);
                }
            }

            renderVehiculos(resultados);
            
        } catch(err) {
            console.error('‚ùå Error en b√∫squeda combinada:', err);
            resultsBody.innerHTML = `<tr><td colspan="6">Error al buscar. Ver consola para detalles.</td></tr>`;
        }
    }

    // Guardar datos originales al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        const originalRows = document.querySelectorAll('#results-body tr');
        if (originalRows.length > 0 && !originalRows[0].innerHTML.includes('No hay')) {
            originalData = Array.from(originalRows).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    patente: cells[0].textContent,
                    marca: cells[1].textContent,
                    modelo: cells[2].textContent,
                    cliente: cells[3].textContent,
                    cliente_rut: cells[4].textContent
                };
            });
        }
    });

    // Event listeners para b√∫squedas - ahora ambos llaman a la misma funci√≥n
    clientInput.addEventListener('input', debounce(function(e){
        realizarBusquedaCombinada();
    }, 300));

    vehiculoInput.addEventListener('input', debounce(function(e){
        realizarBusquedaCombinada();
    }, 300));

})();
</script>
{% endblock %}