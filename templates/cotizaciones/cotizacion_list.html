
{% extends "base.html" %}

{% block title %}
  Historial de cotizaciones
{% endblock title %}

{% load phone_filters %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Historial de Cotizaciones</h2>
  </div>

  <!-- Filtros -->
  <form method="get" class="mb-4">
    <div class="row g-3">
      <div class="col-md-6">
        <label for="cliente" class="form-label">Buscar por cliente:</label>
        <input type="text" id="cliente" name="cliente" class="form-control" 
               placeholder="Nombre del cliente" value="{{ request.GET.cliente }}">
      </div>
      <div class="col-md-4">
        <label for="estado" class="form-label">Filtrar por estado:</label>
        <select id="estado" name="estado" class="form-select">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE" {% if request.GET.estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
          <option value="APROBADA" {% if request.GET.estado == 'APROBADA' %}selected{% endif %}>Aprobada</option>
          <option value="RECHAZADA" {% if request.GET.estado == 'RECHAZADA' %}selected{% endif %}>Rechazada</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel"></i> Filtrar
        </button>
      </div>
    </div>
  </form>

  <!-- Estadísticas rápidas -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ cotizaciones.paginator.count }}</h4>
              <p class="card-text">Total Cotizaciones</p>
            </div>
            <div class="align-self-center">
              <i class="bi bi-file-text fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ cotizaciones_aprobadas }}</h4>
              <p class="card-text">Aprobadas</p>
            </div>
            <div class="align-self-center">
              <i class="bi bi-check-circle fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ cotizaciones_pendientes }}</h4>
              <p class="card-text">Pendientes</p>
            </div>
            <div class="align-self-center">
              <i class="bi bi-clock fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de cotizaciones -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>N° Cotización</th>
          <th>Cliente</th>
          <th>Fecha</th>
          <th>Monto total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for cot in cotizaciones %}
        <tr>
          <td>
            <strong>{{ cot.numero_cotizacion }}</strong>
            {% if cot.servicio %}
              <br>
              <small class="text-muted">
                <i class="bi bi-tools"></i> Servicio #{{ cot.servicio.id }}
              </small>
            {% endif %}
          </td>
          <td>
            {% if cot.cliente %}
              <div class="fw-bold">{{ cot.cliente.nombre }}</div>
              {% if cot.cliente.rut %}
                <small class="text-muted">{{ cot.cliente.rut }}</small>
              {% endif %}
            {% else %}
              <span class="text-muted">Sin cliente</span>
            {% endif %}
          </td>
          <td>
            <div>{{ cot.fecha_creacion|date:"d/m/Y" }}</div>
            <small class="text-muted">{{ cot.fecha_creacion|date:"H:i" }}</small>
          </td>
          <td>
            <strong>${{ cot.monto_total|floatformat:0 }}</strong>
            <br>
            <small class="text-muted">Neto: ${{ cot.subtotal|floatformat:0 }}</small>
          </td>
          <td>
            <form method="post" action="{% url 'cotizaciones:cambiar_estado' cot.id %}" class="d-inline">
              {% csrf_token %}
              <select name="nuevo_estado" class="form-select form-select-sm" style="min-width: 140px;" onchange="this.form.submit()">
                <option value="PENDIENTE" {% if cot.estado_cotizacion == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                <option value="APROBADA" {% if cot.estado_cotizacion == 'APROBADA' %}selected{% endif %}>Aprobada</option>
                <option value="RECHAZADA" {% if cot.estado_cotizacion == 'RECHAZADA' %}selected{% endif %}>Rechazada</option>
              </select>
            </form>
          </td>
          <td class="acciones-celda" style="white-space: nowrap;">
            <a href="{% url 'cotizaciones:descargar_pdf' cot.id %}" 
               class="btn btn-sm btn-outline-danger mb-2" 
               target="_blank"
               title="Ver PDF">
              <i class="bi bi-file-pdf me-1"></i> PDF
            </a>
            {% if cot.cliente.email %}
              <button type="button" class="btn btn-sm btn-outline-warning mb-1 btn-open-email-modal" 
                      data-cot-id="{{ cot.id }}" data-default-email="{{ cot.cliente.email }}" title="Enviar por email a {{ cot.cliente.email }}">
                <i class="bi bi-envelope me-1"></i> Email
              </button>
            {% else %}
              <button class="btn btn-sm btn-outline-secondary mb-1" disabled title="El cliente no tiene email registrado">
                <i class="bi bi-envelope-slash"></i> Sin email
              </button>
            {% endif %}
            {% if cot.cliente and cot.cliente.telefono %}
              {% url 'cotizaciones:descargar_pdf' cot.id as pdf_path %}
              <a href="https://wa.me/{{ cot.cliente.telefono|phone_whatsapp }}?text={{ ("Hola "|add:cot.cliente.nombre|add:", te enviamos tu cotización N°"|add:cot.numero_cotizacion|add:" del "|add:cot.fecha_emision|date:"d/m/Y"|add:" por un total de $")|add:cot.monto_total|floatformat:0|add:". Ver documento: "|add:request.scheme|add:"://"|add:request.get_host|add:pdf_path|urlencode }}"
                class="btn btn-sm btn-outline-success mb-1"
                target="_blank"
                title="Enviar por WhatsApp">
                <i class="bi bi-whatsapp me-1"></i> WhatsApp
              </a>
            {% else %}
              <button class="btn btn-sm btn-outline-secondary mb-1" disabled title="El cliente no tiene número de teléfono">
                <i class="bi bi-whatsapp"></i> Sin número
              </button>
            {% endif %}
            <form method="POST" action="{% url 'cotizaciones:eliminar_cotizacion' cot.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="button" class="btn btn-sm btn-outline-danger mb-1" data-bs-toggle="modal" data-bs-target="#deleteCotModal{{ cot.id }}" title="Eliminar">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </td>
        </tr>
        <!-- Modal eliminar cotización -->
        <div class="modal fade" id="deleteCotModal{{ cot.id }}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirmar eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ¿Seguro que quieres eliminar la cotización <strong>#{{ cot.numero_cotizacion }}</strong>?<br><small class="text-muted">Esta acción no se puede deshacer.</small>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{% url 'cotizaciones:eliminar_cotizacion' cot.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center py-4">
            <div class="text-muted">
              <i class="bi bi-inbox fs-1"></i>
              <p class="mt-2">No hay cotizaciones registradas.</p>
              <p class="small">Las cotizaciones se crean desde los servicios.</p>
              <a href="{% url 'servicios:list' %}" class="btn btn-primary mt-2">
                <i class="bi bi-wrench"></i> Ir a Servicios
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  {% if is_paginated %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1{% if request.GET.cliente %}&cliente={{ request.GET.cliente }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">&laquo; Primera</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.cliente %}&cliente={{ request.GET.cliente }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">Anterior</a>
        </li>
      {% endif %}
      <li class="page-item active">
        <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.cliente %}&cliente={{ request.GET.cliente }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">Siguiente</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.cliente %}&cliente={{ request.GET.cliente }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">Última &raquo;</a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
{% endblock content %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // No hay botón de duplicar en esta vista; se omitió el diálogo.

    // Email modal handling (robust: si bootstrap no está, hace fallback con prompt)
    const emailInput = document.getElementById('emailDestinoInput');
    const emailForm = document.getElementById('emailEnviarForm');

    document.querySelectorAll('.btn-open-email-modal').forEach(btn => {
      btn.addEventListener('click', function() {
        const cotId = this.dataset.cotId;
        const defaultEmail = this.dataset.defaultEmail || '{{ default_from_email }}' || '';
        // ajustar action: usar la ruta generada con id 0 y reemplazar el 0 por el id real
        if (emailForm) {
          const baseAction = "{% url 'cotizaciones:enviar_email' 0 %}";
          emailForm.action = baseAction.replace('/0/', `/${cotId}/`);
        }

        // Si bootstrap está disponible, usar modal; si no, pedir por prompt y enviar
        if (typeof bootstrap !== 'undefined' && document.getElementById('emailCotModal')) {
          const emailModalEl = document.getElementById('emailCotModal');
          let modalInstance = bootstrap.Modal.getInstance(emailModalEl);
          if (!modalInstance) modalInstance = new bootstrap.Modal(emailModalEl);
          if (emailInput) emailInput.value = defaultEmail;
          modalInstance.show();
        } else {
          // Fallback simple
          const entrada = window.prompt('Email destinatario:', defaultEmail || '');
          if (entrada && emailForm) {
            // crear campo hidden si no existe
            let hidden = emailForm.querySelector('input[name="to_email"]');
            if (!hidden) {
              hidden = document.createElement('input');
              hidden.type = 'hidden';
              hidden.name = 'to_email';
              emailForm.appendChild(hidden);
            }
            hidden.value = entrada;
            emailForm.submit();
          }
        }
      });
    });
  });
</script>

<!-- Modal para enviar email editable -->
<div class="modal fade" id="emailCotModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-envelope"></i> Enviar cotización por email</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="emailEnviarForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-2">
            <label for="emailDestinoInput" class="form-label">Email destinatario</label>
            <input type="email" id="emailDestinoInput" name="to_email" class="form-control" required placeholder="destino@ejemplo.com">
            <div class="form-text">Por defecto aparece el email del cliente; puede modificarlo.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock extra_js %}
