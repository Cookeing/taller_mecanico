{% extends "base.html" %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizaci√≥n - Chile</title>
    <link rel="stylesheet" href="{% static 'css/cotizacion.css' %}">
</head>
<body>
    <div class="container">
        <!-- FORMULARIO SEPARADO solo para enviar datos -->
        <form method="POST" id="cotizacion-form" style="display: none;">
            {% csrf_token %}
            {% if servicio %}
            <input type="hidden" name="servicio_id" value="{{ servicio.id }}">
            {% endif %}
            <input type="hidden" name="items_data" id="items-data">
            <!-- Campos Django ocultos -->
            {{ form.empresa_nombre }}
            {{ form.empresa_rut }}
            {{ form.empresa_giro }}
            {{ form.empresa_direccion }}
            {{ form.empresa_telefono }}
            {{ form.empresa_email }}
            {{ form.fecha_emision }}
            {{ form.fecha_validez }}
            {{ form.cliente }}
            {{ form.forma_pago }}
            {{ form.plazo_pago }}
        </form>

        <!-- INTERFAZ VISUAL (NO FORM) -->
        <div id="cotizacion-ui">
            <!-- Header -->
            <div class="header">
                <div class="company-info">
                    <div class="company-name">
               <input type="text" class="company-name-input" placeholder="Ingrese su nombre o el de su compa√±√≠a" 
                   value="{{ form.empresa_nombre.value|default:'' }}" 
                   id="ui-empresa-nombre">
                    </div>
                    <div class="company-details">
                        <div class="info-row">
                            <span class="info-label">RUT:</span>
                <input type="text" class="info-input" placeholder="12.345.678-9" 
                    value="{{ form.empresa_rut.value|default:'' }}" id="ui-empresa-rut">
                        </div>
                        <div class="info-row">
                            <span class="info-label">Giro:</span>
                <input type="text" class="info-input" placeholder="Ej: Servicios de Mec√°nica Automotriz" 
                    value="{{ form.empresa_giro.value|default:'' }}" id="ui-empresa-giro">
                        </div>
                        <div class="info-row">
                            <span class="info-label">Direcci√≥n:</span>
                <input type="text" class="info-input" placeholder="Calle, N√∫mero, Comuna, Ciudad" 
                    value="{{ form.empresa_direccion.value|default:'' }}" id="ui-empresa-direccion">
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tel√©fono:</span>
                <input type="text" class="info-input" placeholder="+56 9 1234 5678" 
                    value="{{ form.empresa_telefono.value|default:'' }}" id="ui-empresa-telefono">
                        </div>
                        <div class="info-row">
                            <span class="info-label">E-mail:</span>
                <input type="text" class="info-input" placeholder="contacto@empresa.cl" 
                    value="{{ form.empresa_email.value|default:'' }}" id="ui-empresa-email">
                        </div>
                    </div>
                </div>
                <div class="logo-section">
                    <div class="logo-upload" id="logo-upload" onclick="document.getElementById('logo-input').click()">
                        <div class="logo-placeholder">Haga clic para cargar logo</div>
                        <input type="file" id="logo-input" accept="image/*" onchange="loadLogo(event)">
                    </div>
                    <div class="document-info">
                        <div class="document-number">
                            <label>N¬∞ </label>
                            <input type="text" class="document-number-input" value="Auto-generado" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="date-row">
                            <label>Fecha Emisi√≥n:</label>
                            <input type="date" class="date-input" id="ui-fecha-emision" 
                                   value="{{ form.fecha_emision.value|default:'' }}">
                        </div>
                        <div class="date-row">
                            <label>Validez hasta:</label>
                            <input type="date" class="date-input" id="ui-fecha-validez" 
                                   value="{{ form.fecha_validez.value|default:'' }}">
                        </div>
                    </div>
                </div>
            </div>

            {% if servicio %}
                <div class="servicio-info-alert" style="background-color: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 14px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: #1976d2; font-size: 16px;">üìã Servicio Vinculado</span>
                    </div>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; align-items: start;">
                        <span style="font-weight: 500;">Veh√≠culo:</span>
                        <span>{{ servicio.vehiculo.patente }} - {{ servicio.vehiculo.marca }} {{ servicio.vehiculo.modelo }}</span>
                        
                        <span style="font-weight: 500;">Cliente:</span>
                        <span>{{ servicio.vehiculo.cliente.nombre }}</span>
                        
                        <span style="font-weight: 500;">Descripci√≥n:</span>
                        <span>{{ servicio.descripcion_trabajo|truncatechars:100 }}</span>
                        
                        <span style="font-weight: 500;">Estado:</span>
                        <span>{{ servicio.estado_servicio }}</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 13px; color: #555;">
                        <em>Esta cotizaci√≥n se vincular√° autom√°ticamente al servicio.</em>
                    </div>
                </div>
            {% endif %}

            <!-- Client Section -->
            <div class="client-section">
                <div class="client-section-header">
                    <div class="section-title">Datos del Cliente</div>
                    <div class="client-selector">
                        <label>Seleccionar Cliente:</label>
                        <select id="ui-cliente-select">
                            <option value="">-- Seleccionar cliente (opcional) --</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" 
                                    data-rut="{{ cliente.rut|default:'' }}"
                                    data-telefono="{{ cliente.telefono|default:'' }}"
                                    data-direccion="{{ cliente.direccion|default:'' }}"
                                    data-email="{{ cliente.email|default:'' }}"
                                    data-contacto="{{ cliente.contacto|default:'' }}"
                                    {% if form.cliente.value == cliente.id|stringformat:"i" %}selected{% endif %}>
                                {{ cliente.nombre }} {% if cliente.rut %}({{ cliente.rut }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="client-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Nombre o Raz√≥n Social</label>
                        <input type="text" class="form-input" id="ui-client-name" placeholder="Nombre completo o raz√≥n social del cliente (opcional)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">RUT</label>
                        <input type="text" class="form-input" id="ui-client-rut" placeholder="12.345.678-9 (opcional)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tel√©fono</label>
                        <input type="text" class="form-input" id="ui-client-phone" placeholder="+56 9 1234 5678 (opcional)">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Direcci√≥n Completa</label>
                        <input type="text" class="form-input" id="ui-client-address" placeholder="Calle, N√∫mero, Comuna, Ciudad, Regi√≥n (opcional)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Correo Electr√≥nico</label>
                        <input type="text" class="form-input" id="ui-client-email" placeholder="cliente@email.cl (opcional)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contacto</label>
                        <input type="text" class="form-input" id="ui-client-contact" placeholder="Nombre de persona de contacto (opcional)">
                    </div>
                </div>
            </div>

            <!-- Categories Container -->
            <div class="categories-container" id="categories-container">
                <!-- Categories will be added here dynamically -->
            </div>

            <!-- Add Category Button -->
            <button type="button" class="add-category-btn" id="add-category-btn">+ Agregar Categor√≠a</button>

            <!-- Totals Section -->
            <div class="clearfix">
                <div class="totals-section">
                    <div class="total-row subtotal">
                        <span class="total-label">SUBTOTAL (Neto)</span>
                        <span class="total-value" id="subtotal">$0</span>
                    </div>
                    <div class="total-row iva">
                        <span class="total-label">IVA (19%)</span>
                        <span class="total-value" id="iva">$0</span>
                    </div>
                    <div class="total-row final">
                        <span class="total-label">TOTAL</span>
                        <span class="total-value" id="total">$0</span>
                    </div>
                </div>
            </div>

            <!-- Payment Conditions -->
            <div class="payment-conditions clearfix">
                <div class="section-title">Condiciones de Pago</div>
                <div class="payment-grid">
                    <div class="form-group">
                        <label class="form-label">Forma de Pago</label>
                        <select class="form-input" id="ui-forma-pago">
                            <option value="">Seleccione...</option>
                            <option value="transferencia" {% if form.forma_pago.value == 'transferencia' %}selected{% endif %}>Transferencia Bancaria</option>
                            <option value="efectivo" {% if form.forma_pago.value == 'efectivo' %}selected{% endif %}>Efectivo</option>
                            <option value="cheque" {% if form.forma_pago.value == 'cheque' %}selected{% endif %}>Cheque</option>
                            <option value="tarjeta" {% if form.forma_pago.value == 'tarjeta' %}selected{% endif %}>Tarjeta de Cr√©dito/D√©bito</option>
                            <option value="otro" {% if form.forma_pago.value == 'otro' %}selected{% endif %}>Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Plazo de Pago</label>
                        <select class="form-input" id="ui-plazo-pago">
                            <option value="">Seleccione...</option>
                            <option value="contado" {% if form.plazo_pago.value == 'contado' %}selected{% endif %}>Al Contado</option>
                            <option value="15" {% if form.plazo_pago.value == '15' %}selected{% endif %}>15 d√≠as</option>
                            <option value="30" {% if form.plazo_pago.value == '30' %}selected{% endif %}>30 d√≠as</option>
                            <option value="45" {% if form.plazo_pago.value == '45' %}selected{% endif %}>45 d√≠as</option>
                            <option value="60" {% if form.plazo_pago.value == '60' %}selected{% endif %}>60 d√≠as</option>
                            <option value="90" {% if form.plazo_pago.value == '90' %}selected{% endif %}>90 d√≠as</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line">
                        <div class="signature-label">Firma Emisor</div>
                        <div class="signature-sublabel">Nombre y RUT</div>
                    </div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">
                        <div class="signature-label">Firma y Timbre Cliente</div>
                        <div class="signature-sublabel">Aceptaci√≥n de la cotizaci√≥n</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-buttons" style="text-align: center; margin: 30px 0;">
                <button type="button" class="print-button" id="btn-guardar" style="position: static; margin: 10px;">üíæ Guardar Cotizaci√≥n</button>
                <button type="button" class="print-button" id="btn-imprimir" style="position: static; margin: 10px; background-color: #28a745;">üñ®Ô∏è Imprimir / PDF</button>
                <button type="button" class="print-button" id="btn-exportar" style="position: static; margin: 10px; background-color: #17a2b8;">üìä Exportar CSV</button>
                <a href="{% url 'cotizaciones:listar_cotizaciones' %}" class="print-button" style="position: static; margin: 10px; background-color: #6c757d; text-decoration: none; display: inline-block;">‚ùå Cancelar</a>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="{% static 'js/cotizacion.js' %}"></script>
    <script>
        // Inicializaci√≥n espec√≠fica para Django
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Iniciando cotizaci√≥n ===');
            
            // Verificar que las funciones est√©n disponibles
            console.log('Funci√≥n addCategory disponible:', typeof addCategory);
            console.log('Funci√≥n calculateGrandTotal disponible:', typeof calculateGrandTotal);
            
            // Cargar items existentes si estamos editando
            {% if editando and items_existentes %}
            const itemsExistentes = {{ items_existentes|safe }};
            console.log('MODO EDICI√ìN - Items existentes:', itemsExistentes);
            
            if (itemsExistentes && itemsExistentes.length > 0) {
                // Agrupar items por categor√≠a
                const itemsPorCategoria = {};
                itemsExistentes.forEach(item => {
                    if (!itemsPorCategoria[item.categoria]) {
                        itemsPorCategoria[item.categoria] = [];
                    }
                    itemsPorCategoria[item.categoria].push(item);
                });
                
                console.log('Items agrupados por categor√≠a:', itemsPorCategoria);
                
                // Crear una categor√≠a por cada grupo
                Object.keys(itemsPorCategoria).forEach(nombreCategoria => {
                    console.log('Creando categor√≠a:', nombreCategoria);
                    const nuevaCategoria = addCategory();
                    
                    if (nuevaCategoria) {
                        // Establecer nombre de categor√≠a
                        const categoryNameInput = nuevaCategoria.querySelector('.category-name-input');
                        if (categoryNameInput) {
                            categoryNameInput.value = nombreCategoria;
                        }
                        
                        // Obtener el tbody de esta categor√≠a
                        const tbody = nuevaCategoria.querySelector('.category-body');
                        if (tbody) {
                            tbody.innerHTML = ''; // Limpiar la fila por defecto
                            
                            // Agregar cada item de esta categor√≠a
                            itemsPorCategoria[nombreCategoria].forEach((item, index) => {
                                console.log('Agregando item:', item);
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="item-number">${index + 1}</td>
                                    <td class="description-cell"><input type="text" placeholder="Descripci√≥n del servicio" value="${item.descripcion}"></td>
                                    <td class="unit-cell">
                                        <select>
                                            <option value="un">Unidad</option>
                                            <option value="hr">Hora</option>
                                            <option value="servicio">Servicio</option>
                                        </select>
                                    </td>
                                    <td class="quantity-cell"><input type="number" class="quantity" value="${item.cantidad}" min="0" step="0.01"></td>
                                    <td class="unit-price-cell"><input type="number" class="unit-price" value="${item.precio_unitario}" min="0" step="1"></td>
                                    <td class="total-cell"><input type="text" class="row-total" value="$${Math.round(item.cantidad * item.precio_unitario)}" readonly></td>
                                    <td class="actions-cell">
                                        <button type="button" class="delete-row-btn" onclick="deleteRow(this)">‚úï</button>
                                    </td>
                                `;
                                tbody.appendChild(row);
                                
                                // Event listeners para recalcular
                                const quantityInput = row.querySelector('.quantity');
                                const priceInput = row.querySelector('.unit-price');
                                
                                if (quantityInput) {
                                    quantityInput.addEventListener('input', function() {
                                        calculateRow(this);
                                    });
                                }
                                
                                if (priceInput) {
                                    priceInput.addEventListener('input', function() {
                                        calculateRow(this);
                                    });
                                }
                            });
                            
                            // Recalcular totales
                            calculateGrandTotal();
                        }
                    }
                });
                
                console.log('Items cargados correctamente');
            } else {
                console.log('No hay items, creando categor√≠a vac√≠a');
                addCategory();
            }
            {% else %}
            console.log('MODO NUEVA COTIZACI√ìN - Creando categor√≠a inicial');
            addCategory();
            {% endif %}

            // 2. Sincronizar datos de cliente si ya hay uno seleccionado
            const clienteSelect = document.getElementById('ui-cliente-select');
            console.log('Cliente select encontrado:', clienteSelect);
            console.log('Valor del cliente select:', clienteSelect ? clienteSelect.value : 'N/A');
            
            if (clienteSelect && clienteSelect.value) {
                console.log('Cliente ya seleccionado, cargando datos...');
                const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
                console.log('Opci√≥n seleccionada:', selectedOption);
                
                if (selectedOption && selectedOption.value) {
                    const nombre = selectedOption.text.split(' (')[0];
                    const rut = selectedOption.dataset.rut || '';
                    const telefono = selectedOption.dataset.telefono || '';
                    const direccion = selectedOption.dataset.direccion || '';
                    const email = selectedOption.dataset.email || '';
                    const contacto = selectedOption.dataset.contacto || '';
                    
                    console.log('Datos a cargar:', {nombre, rut, telefono, direccion, email, contacto});
                    
                    document.getElementById('ui-client-name').value = nombre;
                    document.getElementById('ui-client-rut').value = rut;
                    document.getElementById('ui-client-phone').value = telefono;
                    document.getElementById('ui-client-address').value = direccion;
                    document.getElementById('ui-client-email').value = email;
                    document.getElementById('ui-client-contact').value = contacto;
                    
                    console.log('Datos del cliente cargados correctamente');
                }
            }

            // 3. Event listeners
            const addCategoryBtn = document.getElementById('add-category-btn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', function() {
                    console.log('Agregando categor√≠a...');
                    addCategory();
                });
            } else {
                console.error('Bot√≥n add-category-btn no encontrado');
            }

            const btnImprimir = document.getElementById('btn-imprimir');
            if (btnImprimir) {
                btnImprimir.addEventListener('click', printQuote);
            }

            const btnExportar = document.getElementById('btn-exportar');
            if (btnExportar) {
                btnExportar.addEventListener('click', exportToCSV);
            }

            // 4. Cliente selection
            if (clienteSelect) {
                clienteSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    
                    if (selectedOption.value) {
                        document.getElementById('ui-client-name').value = selectedOption.text.split(' (')[0];
                        document.getElementById('ui-client-rut').value = selectedOption.dataset.rut || '';
                        document.getElementById('ui-client-phone').value = selectedOption.dataset.telefono || '';
                        document.getElementById('ui-client-address').value = selectedOption.dataset.direccion || '';
                        document.getElementById('ui-client-email').value = selectedOption.dataset.email || '';
                        document.getElementById('ui-client-contact').value = selectedOption.dataset.contacto || '';
                    } else {
                        clearClientFields();
                    }
                });
            }

            // 5. Bot√≥n guardar - SOLO ESTE ENV√çA EL FORMULARIO
            const btnGuardar = document.getElementById('btn-guardar');
            if (btnGuardar) {
                btnGuardar.addEventListener('click', function() {
                    console.log('Preparando y enviando formulario...');
                    prepararYEnviarFormulario();
                });
            } else {
                console.error('Bot√≥n btn-guardar no encontrado');
            }

            console.log('Inicializaci√≥n completada');
        });

        function clearClientFields() {
            document.getElementById('ui-client-name').value = '';
            document.getElementById('ui-client-rut').value = '';
            document.getElementById('ui-client-phone').value = '';
            document.getElementById('ui-client-address').value = '';
            document.getElementById('ui-client-email').value = '';
            document.getElementById('ui-client-contact').value = '';
        }

        function prepararYEnviarFormulario() {
            // 1. Sincronizar datos de la UI al formulario oculto
            document.getElementById('id_empresa_nombre').value = document.getElementById('ui-empresa-nombre').value;
            document.getElementById('id_empresa_rut').value = document.getElementById('ui-empresa-rut').value;
            document.getElementById('id_empresa_giro').value = document.getElementById('ui-empresa-giro').value;
            document.getElementById('id_empresa_direccion').value = document.getElementById('ui-empresa-direccion').value;
            document.getElementById('id_empresa_telefono').value = document.getElementById('ui-empresa-telefono').value;
            document.getElementById('id_empresa_email').value = document.getElementById('ui-empresa-email').value;
            document.getElementById('id_fecha_emision').value = document.getElementById('ui-fecha-emision').value;
            document.getElementById('id_fecha_validez').value = document.getElementById('ui-fecha-validez').value;
            document.getElementById('id_cliente').value = document.getElementById('ui-cliente-select').value;
            document.getElementById('id_forma_pago').value = document.getElementById('ui-forma-pago').value;
            document.getElementById('id_plazo_pago').value = document.getElementById('ui-plazo-pago').value;

            // 2. Preparar items_data
            updateItemsData();

            // 3. Enviar formulario
            console.log('Enviando formulario...');
            document.getElementById('cotizacion-form').submit();
        }
    </script>
</body>
</html>
{% endblock %}